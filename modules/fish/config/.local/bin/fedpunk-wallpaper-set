#!/usr/bin/env fish
# Set wallpaper from current theme (uses first wallpaper found)
# Usage: fedpunk-wallpaper-set [theme-name]
# If no theme-name provided, uses current theme
# Uses swaybg (like omarchy)

set themes_dir "$HOME/.local/share/fedpunk/themes"
set hyprland_conf "$HOME/.config/hypr/hyprland.conf"
set current_wallpaper_link "$HOME/.config/hypr/wallpapers/current"

# Determine theme name
if test (count $argv) -ge 1
    set theme_name (echo $argv[1] | string lower | string replace -a ' ' '-')
else
    # Extract current theme from hyprland.conf
    set current_line (grep "source.*themes.*hyprland.conf" $hyprland_conf 2>/dev/null)

    if test -z "$current_line"
        echo "Error: No theme set and no theme name provided"
        exit 1
    end

    set theme_name (echo $current_line | sed 's|.*themes/\([^/]*\)/.*|\1|')
end

set backgrounds_dir "$themes_dir/$theme_name/backgrounds"

# Check if backgrounds directory exists
if not test -d "$backgrounds_dir"
    echo "⊘ No wallpapers found for theme '$theme_name'"
    # Clear current wallpaper link if it exists
    rm -f "$current_wallpaper_link"
    return 0
end

# Get first background image
set first_wallpaper (find -L "$backgrounds_dir" -type f \( -iname "*.jpg" -o -iname "*.png" -o -iname "*.jpeg" \) | sort | head -1)

if test -z "$first_wallpaper"
    echo "⊘ No wallpaper images found in theme backgrounds"
    rm -f "$current_wallpaper_link"
    # Set black background if no wallpaper
    pkill -x swaybg 2>/dev/null
    swaybg --color '#000000' >/dev/null 2>&1 &
    disown
    return 0
end

# Create wallpapers directory if needed and set wallpaper symlink
mkdir -p (dirname "$current_wallpaper_link")
ln -sf "$first_wallpaper" "$current_wallpaper_link"

# Relaunch swaybg with new wallpaper (omarchy style)
pkill -x swaybg 2>/dev/null
swaybg -i "$current_wallpaper_link" -m fill >/dev/null 2>&1 &
disown

set wallpaper_name (basename "$first_wallpaper")
echo "✓ Wallpaper set to: $wallpaper_name"
