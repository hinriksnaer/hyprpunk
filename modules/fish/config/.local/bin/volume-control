#!/usr/bin/env fish
# Volume control with OSD notification
# Usage: volume-control [up|down|mute]

set action $argv[1]

# Get the currently active audio sink
# First, try to find a sink with active streams (actually playing audio)
set stream_sink_name (wpctl status | grep -A 50 "Streams:" | grep ">" | head -1 | sed 's/.*> \([^:]*\):.*/\1/')

if test -n "$stream_sink_name"
    # Find the sink ID that matches the stream's sink name (using grep -F for literal string matching)
    set active_sink (wpctl status | awk '/Sinks:/,/Sources:/' | grep -F "$stream_sink_name" | head -1 | awk '{print $2}' | tr -d '.')
else
    # No active streams, use the default sink (marked with *)
    set active_sink (wpctl status | awk '/Sinks:/,/Sources:/' | grep "\*" | head -1 | awk '{print $3}' | tr -d '.')
end

# Fallback to default if active_sink is still empty
if test -z "$active_sink"
    set active_sink "@DEFAULT_AUDIO_SINK@"
end

# Apply volume change
switch $action
    case up
        wpctl set-volume $active_sink 5%+
    case down
        wpctl set-volume $active_sink 5%-
    case mute
        wpctl set-mute $active_sink toggle
    case '*'
        echo "Usage: volume-control [up|down|mute]"
        exit 1
end

# Get current volume and mute status
set volume_info (wpctl get-volume $active_sink)
set volume_value (echo $volume_info | awk '{print $2}')
set volume_percent (math "round($volume_value * 100)")
set is_muted (echo $volume_info | grep -q "MUTED" && echo "yes" || echo "no")

# Determine icon and message
if test "$is_muted" = "yes"
    set icon "audio-volume-muted"
    set message "Muted"
else if test $volume_percent -eq 0
    set icon "audio-volume-muted"
    set message "Volume: 0%"
else if test $volume_percent -lt 33
    set icon "audio-volume-low"
    set message "Volume: $volume_percent%"
else if test $volume_percent -lt 66
    set icon "audio-volume-medium"
    set message "Volume: $volume_percent%"
else
    set icon "audio-volume-high"
    set message "Volume: $volume_percent%"
end

# Create visual bar
set bar_length 20
set filled_length (math "round($volume_percent / 5)")
set bar ""
for i in (seq 1 $bar_length)
    if test $i -le $filled_length
        set bar "$barâ–ˆ"
    else
        set bar "$barâ–‘"
    end
end

# Send notification with volume bar
if test "$is_muted" = "yes"
    notify-send -t 1500 -h string:x-canonical-private-synchronous:volume -u low "Volume" "ðŸ”‡ Muted"
else
    notify-send -t 1500 -h string:x-canonical-private-synchronous:volume -u low "Volume" "$message\n$bar"
end
