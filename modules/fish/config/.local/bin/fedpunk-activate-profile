#!/usr/bin/env fish
# Activate a Fedpunk profile
# Usage: fedpunk-activate-profile <profile-name>
#
# This script:
#   1. Creates .active-config symlink
#   2. Reads profile's fedpunk.toml
#   3. Installs extra packages
#   4. Runs setup scripts
#   5. Profile configs are deployed via Stow when modules are deployed

set FEDPUNK_PATH "$HOME/.local/share/fedpunk"
set PROFILES_DIR "$FEDPUNK_PATH/profiles"

# Color codes
set C_RESET '\033[0m'
set C_GREEN '\033[0;32m'
set C_BLUE '\033[0;34m'
set C_YELLOW '\033[0;33m'
set C_RED '\033[0;31m'
set C_GRAY '\033[0;90m'

function info
    echo -e "$C_BLUE→$C_RESET $argv"
end

function success
    echo -e "$C_GREEN✓$C_RESET $argv"
end

function warning
    echo -e "$C_YELLOW⚠$C_RESET $argv"
end

function error
    echo -e "$C_RED✗$C_RESET $argv"
end

function show_usage
    echo "Usage: fedpunk-activate-profile <profile-name>"
    echo ""
    echo "Activate a Fedpunk profile by:"
    echo "  • Creating .active-config symlink"
    echo "  • Installing extra packages from fedpunk.toml"
    echo "  • Running setup scripts from fedpunk.toml"
    echo "  • Note: Configs deployed via module system (Stow)"
    echo ""
    echo "Available profiles:"
    if test -d "$PROFILES_DIR"
        for profile in (find "$PROFILES_DIR" -maxdepth 1 -mindepth 1 -type d -exec basename {} \;)
            echo "  • $profile"
        end
    else
        echo "  (No profiles directory found)"
    end
    echo ""
    echo "Examples:"
    echo "  fedpunk-activate-profile dev              # Activate dev profile"
    echo "  fedpunk-activate-profile example          # Activate example profile (template)"
end

function detect_environment
    # Detect if desktop environment is installed
    if command -v Hyprland >/dev/null 2>&1
        echo "desktop"
    else
        echo "terminal"
    end
end

function categorize_package
    set pkg $argv[1]

    # Desktop packages (require Hyprland/Wayland)
    set desktop_packages hyprland kitty waybar rofi mako hypr

    if contains $pkg $desktop_packages
        echo "desktop"
    else
        echo "terminal"
    end
end

function parse_toml_packages
    set toml_file $argv[1]

    if not test -f "$toml_file"
        return 0
    end

    # Extract packages from extra = [...] line
    set packages_line (grep '^extra' "$toml_file" | sed 's/extra = \[//; s/\]//; s/"//g; s/,/ /g' | string trim)

    if test -n "$packages_line"
        echo $packages_line
    end
end

function parse_toml_scripts
    set toml_file $argv[1]

    if not test -f "$toml_file"
        return 0
    end

    # Extract scripts from setup = [ ... ] section (handles multi-line)
    set scripts (awk '/setup = \[/,/\]/' "$toml_file" | grep -o '"[^"]*"' | tr -d '"')

    if test -n "$scripts"
        printf '%s\n' $scripts
    end
end

# Main script
if test (count $argv) -eq 0
    error "No profile specified"
    echo ""
    show_usage
    exit 1
end

set profile_name $argv[1]

# Handle --help
if test "$profile_name" = "--help" -o "$profile_name" = "-h"
    show_usage
    exit 0
end

set profile_path "$PROFILES_DIR/$profile_name"
set active_config_link "$FEDPUNK_PATH/.active-config"

# Validate profile exists
if not test -d "$profile_path"
    error "Profile not found: $profile_name"
    echo ""
    echo "Available profiles:"
    for profile in (find "$PROFILES_DIR" -maxdepth 1 -mindepth 1 -type d -exec basename {} \;)
        echo "  • $profile"
    end
    exit 1
end

echo ""
echo -e "$C_BLUE━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$C_RESET"
echo -e "$C_BLUE  Activating Profile: $profile_name$C_RESET"
echo -e "$C_BLUE━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$C_RESET"
echo ""

# Detect environment
set env_type (detect_environment)
if test "$env_type" = "desktop"
    info "Environment: Desktop (Hyprland detected)"
else
    info "Environment: Terminal-only"
end
echo ""

# Step 1: Create .active-config symlink
info "Step 1: Creating .active-config symlink"
if test -L "$active_config_link"
    set old_target (readlink "$active_config_link")
    rm "$active_config_link"
    success "Removed old symlink (was pointing to: "(basename $old_target)")"
else if test -e "$active_config_link"
    error ".active-config exists but is not a symlink"
    exit 1
end

# Create relative symlink (user-agnostic)
cd "$FEDPUNK_PATH"
ln -s "profiles/$profile_name" ".active-config"
success "Created .active-config → profiles/$profile_name"
echo ""

# Step 2: Read fedpunk.toml and install packages
set toml_file "$profile_path/fedpunk.toml"
if test -f "$toml_file"
    info "Step 2: Installing extra packages"
    set packages (parse_toml_packages "$toml_file")

    if test -n "$packages"
        echo "  Packages to install: $packages"
        if sudo dnf install -y $packages
            success "Packages installed successfully"
        else
            warning "Some packages may have failed to install (check output above)"
        end
    else
        echo "  No extra packages defined"
    end
else
    warning "No fedpunk.toml found, skipping package installation"
end
echo ""

# Step 3: Run setup scripts
if test -f "$toml_file"
    info "Step 3: Running setup scripts"
    set scripts (parse_toml_scripts "$toml_file")

    if test -n "$scripts"
        for script in $scripts
            set script_path "$profile_path/$script"
            if test -f "$script_path"
                echo "  Running: $script"
                if fish "$script_path"
                    success "  Completed: $script"
                else
                    warning "  Failed: $script (exit code: $status)"
                end
            else
                warning "  Script not found: $script_path"
            end
        end
    else
        echo "  No setup scripts defined"
    end
else
    warning "No fedpunk.toml found, skipping setup scripts"
end
echo ""

# Step 4: Deploy configs with auto-detection
info "Step 4: Deploying configurations"

set config_dir "$profile_path/config"
if not test -d "$config_dir"
    warning "No config directory found in profile"
    echo ""
    echo -e "$C_GREEN━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$C_RESET"
    echo -e "$C_GREEN  Profile activated: $profile_name$C_RESET"
    echo -e "$C_GREEN━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$C_RESET"
    echo ""
    exit 0
end

# Note: Profile-specific configs are handled through the plugin system
# Plugins in profiles/<name>/plugins/ are deployed via the module system
if test -d "$config_dir"
    set packages (find "$config_dir" -maxdepth 1 -mindepth 1 -type d -exec basename {} \;)
    if test (count $packages) -gt 0
        info "Profile has "(count $packages)" config package(s): $packages"
        info "Deploy profile plugins via: fedpunk module deploy plugins/<name>"
    end
end

echo ""
echo -e "$C_GREEN━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$C_RESET"
echo -e "$C_GREEN  ✓ Profile activated: $profile_name$C_RESET"
echo -e "$C_GREEN━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$C_RESET"
echo ""

if test "$env_type" = "terminal"
    info "Next steps:"
    echo "  • Restart your shell: exec fish"
    echo "  • Check your configs: ls -la ~/.config/"
else
    info "Next steps:"
    echo "  • Restart your shell: exec fish"
    echo "  • Reload Hyprland: Super+Shift+C or logout/login"
    echo "  • Check your configs: ls -la ~/.config/"
end
echo ""
