#!/usr/bin/env fish
# Fish shell post-install setup
# Handles: Setting fish as default shell

echo "[fish/install] Script started" >&2
echo "[fish/install] Current SHELL env: $SHELL" >&2
echo "[fish/install] Fish path: "(type -p fish) >&2
echo "[fish/install] Current USER: $USER" >&2

# Get the actual default shell from /etc/passwd (not the env var which might be empty)
set -l current_shell (getent passwd $USER | cut -d: -f7)
set -l fish_path (type -p fish)

echo "[fish/install] Configured shell in /etc/passwd: $current_shell" >&2
echo "[fish/install] Fish location: $fish_path" >&2

# Set fish as default shell if not already
if test "$current_shell" != "$fish_path"
    echo "[fish/install] Setting fish as default shell..." >&2
    echo "[fish/install] Running: sudo chsh -s $fish_path $USER" >&2
    sudo chsh -s $fish_path $USER

    if test $status -eq 0
        echo "[fish/install] ✓ Fish is now your default shell" >&2
        echo "[fish/install]   Please log out and back in for changes to take effect" >&2
    else
        echo "[fish/install] ✗ Failed to set fish as default shell (exit code: $status)" >&2
        echo "[fish/install]   You may need to run: sudo chsh -s $fish_path $USER" >&2
        exit 1
    end
else
    echo "[fish/install] ✓ Fish is already your default shell" >&2
end

echo "[fish/install] Script completed successfully" >&2
