#!/usr/bin/env fish
# Setup NVIDIA drivers with Wayland support

source "$FEDPUNK_ROOT/lib/fish/ui.fish"

ui-info "Configuring NVIDIA drivers"

# Enable nvidia-persistenced service
ui-spin --title "Enabling NVIDIA persistence daemon..." -- fish -c '
    sudo systemctl enable nvidia-persistenced >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "NVIDIA persistence daemon enabled"
else
    ui-info "NVIDIA persistence daemon already enabled"
end

# Create modprobe configuration
ui-spin --title "Creating NVIDIA modprobe configuration..." -- fish -c '
    printf "%s\n" \
        "# Disable nouveau (open source NVIDIA driver)" \
        "blacklist nouveau" \
        "options nouveau modeset=0" \
        "" \
        "# NVIDIA driver options" \
        "options nvidia-drm modeset=1 fbdev=1" \
        "options nvidia NVreg_UsePageAttributeTable=1" \
        "options nvidia NVreg_InitializeSystemMemoryAllocations=0" | \
        sudo tee /etc/modprobe.d/nvidia.conf >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "NVIDIA modprobe configured"
else
    ui-warning "Failed to create modprobe configuration"
end

# Add NVIDIA modules to initramfs
ui-spin --title "Adding NVIDIA modules to initramfs..." -- fish -c '
    echo '\''add_drivers+=" nvidia nvidia_modeset nvidia_uvm nvidia_drm "'\'' | \
        sudo tee /etc/dracut.conf.d/nvidia.conf >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "NVIDIA modules added to initramfs"
else
    ui-warning "Failed to add modules to initramfs"
end

# Update kernel parameters using grubby (proper Fedora tool)
ui-info "Configuring NVIDIA kernel parameters"

# Add each parameter if not already present
set -l params "rd.driver.blacklist=nouveau" "modprobe.blacklist=nouveau" "nvidia-drm.modeset=1" "nvidia_drm.fbdev=1"

for param in $params
    # Check if parameter already exists
    if not cat /proc/cmdline | grep -q "$param"
        ui-spin --title "Adding kernel parameter: $param" -- sudo grubby --update-kernel=ALL --args="$param"

        if test $status -eq 0
            ui-success "Added: $param"
        else
            ui-warning "Failed to add: $param"
        end
    else
        ui-info "Already present: $param"
    end
end

# Regenerate initramfs
ui-info "Regenerating initramfs (this may take a minute)"
ui-spin --title "Regenerating initramfs..." -- fish -c '
    sudo dracut --force >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "Initramfs regenerated"
else
    ui-error "Failed to regenerate initramfs"
    exit 1
end

# Check for secure boot
if bootctl status 2>/dev/null | grep -q "Secure Boot: enabled"
    ui-warning "Secure Boot is enabled"
    ui-info "The NVIDIA driver needs to be signed or Secure Boot disabled"
    ui-info "Option 1: Disable Secure Boot in BIOS/UEFI (recommended)"
    ui-info "Option 2: Sign the kernel module after reboot"
end

# Enable NVIDIA configuration in Hyprland if it exists
set hyprland_config "$HOME/.config/hypr/hyprland.conf"
if test -f "$hyprland_config"
    ui-spin --title "Enabling NVIDIA config in Hyprland..." -- fish -c '
        if not grep -q "nvidia.conf" "'$hyprland_config'"
            printf "%s\n" \
                "" \
                "# NVIDIA Configuration (auto-added)" \
                "source = \$HOME/.config/hypr/conf.d/nvidia.conf" >> "'$hyprland_config'"
        end >/dev/null 2>&1
    '

    if test $status -eq 0
        ui-success "Hyprland NVIDIA config enabled"
    end
end

ui-success "NVIDIA driver setup complete"
ui-warning "REBOOT REQUIRED for drivers to take effect"
ui-info "After reboot, verify with: nvidia-smi"
