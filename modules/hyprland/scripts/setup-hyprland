#!/usr/bin/env fish
# Setup Hyprland post-installation tasks

source "$FEDPUNK_ROOT/lib/fish/ui.fish"

ui-info "Setting up Hyprland environment"

# Create placeholder config files that are sourced by hyprland.conf
# These prevent Hyprland from failing on first startup
ui-spin --title "Creating placeholder config files..." -- fish -c '
    # Create active-mode.conf placeholder (will be populated by mode-specific config)
    if not test -e ~/.config/hypr/active-mode.conf
        echo "# Active mode configuration (will be set by fedpunk)" > ~/.config/hypr/active-mode.conf
    end

    # Create active-theme.conf placeholder (will be populated by setup-themes)
    if not test -e ~/.config/hypr/active-theme.conf
        echo "# Active theme configuration (will be set by theme manager)" > ~/.config/hypr/active-theme.conf
    end
'

if test $status -eq 0
    ui-success "Placeholder config files created"
else
    ui-warning "Failed to create placeholder files"
end

# Link mode-specific Hyprland configuration to active-mode.conf
# The profile root is 3 levels up from this script (modules/hyprland/scripts/)
set script_dir (dirname (status --current-filename))
set profile_root (realpath "$script_dir/../../..")

# Try to detect the active mode from fedpunk's active-profile file
if test -f ~/.config/hyprpunk/active-profile
    set active_mode (cat ~/.config/hyprpunk/active-profile 2>/dev/null)
else if test -f ~/.local/share/fedpunk/.active-profile
    set active_mode (cat ~/.local/share/fedpunk/.active-profile 2>/dev/null)
else
    # Auto-detect mode based on hardware
    ui-info "No active profile found, auto-detecting mode..."

    # Check if battery exists (laptop detection)
    if test -d /sys/class/power_supply/BAT0 -o -d /sys/class/power_supply/BAT1
        set active_mode "laptop"
        ui-info "Battery detected, using laptop mode"
    else
        set active_mode "desktop"
        ui-info "No battery detected, using desktop mode"
    end

    # Persist the detected mode for future runs
    mkdir -p ~/.config/hyprpunk
    echo $active_mode > ~/.config/hyprpunk/active-profile
    ui-success "Mode persisted to ~/.config/hyprpunk/active-profile"
end

# If we found the mode and its hypr.conf exists, link it
if test -n "$active_mode" -a -f "$profile_root/modes/$active_mode/hypr.conf"
    ui-spin --title "Linking mode configuration..." -- fish -c '
        echo "# Active Mode: '"$active_mode"'
# This file is runtime-generated and gitignored
# Managed by fedpunk profile system

source = '"$profile_root"'/modes/'"$active_mode"'/hypr.conf" > ~/.config/hypr/active-mode.conf
    '

    if test $status -eq 0
        ui-success "Mode configuration linked: $active_mode"
    else
        ui-warning "Failed to link mode configuration"
    end
else
    ui-warning "Mode configuration file not found: $profile_root/modes/$active_mode/hypr.conf"
end

# Update user directories
ui-spin --title "Updating user directories..." -- fish -c '
    xdg-user-dirs-update >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "User directories updated"
else
    ui-warning "User directories update may have issues"
end

# SELinux contexts are handled by system-config module
# No need to restore here to avoid duplicate work

# Enable mako notification service
ui-spin --title "Enabling mako notification service..." -- fish -c '
    systemctl --user enable mako.service >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "Mako notification service enabled"
else
    ui-warning "Mako service enablement may have issues"
end

# Update graphics stack
ui-spin --title "Updating graphics stack..." -- fish -c '
    sudo dnf upgrade -qy --skip-unavailable mesa-dri-drivers mesa-libGL mesa-libEGL libdrm >/dev/null 2>&1 || true
'

if test $status -eq 0
    ui-success "Graphics stack updated"
else
    ui-warning "Graphics stack update may have issues"
end

ui-success "Hyprland setup complete"

# Reload Hyprland configuration if it's currently running
if hyprctl version >/dev/null 2>&1
    ui-spin --title "Reloading Hyprland configuration..." -- fish -c '
        hyprctl reload >/dev/null 2>&1
    '

    if test $status -eq 0
        ui-success "Hyprland configuration reloaded"
    else
        ui-warning "Failed to reload Hyprland configuration"
    end
else
    ui-info "Start Hyprland with: Hyprland (from TTY)"
end
