#!/usr/bin/env fish
# Setup Hyprland post-installation tasks

source "$FEDPUNK_ROOT/lib/fish/ui.fish"

ui-info "Setting up Hyprland environment"

# Update user directories
ui-spin --title "Updating user directories..." -- fish -c '
    xdg-user-dirs-update >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "User directories updated"
else
    ui-warning "User directories update may have issues"
end

# SELinux contexts are handled by system-config module
# No need to restore here to avoid duplicate work

# Enable mako notification service
ui-spin --title "Enabling mako notification service..." -- fish -c '
    systemctl --user enable mako.service >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "Mako notification service enabled"
else
    ui-warning "Mako service enablement may have issues"
end

# Update graphics stack
ui-spin --title "Updating graphics stack..." -- fish -c '
    sudo dnf upgrade -qy --skip-unavailable mesa-dri-drivers mesa-libGL mesa-libEGL libdrm >/dev/null 2>&1 || true
'

if test $status -eq 0
    ui-success "Graphics stack updated"
else
    ui-warning "Graphics stack update may have issues"
end

ui-success "Hyprland setup complete"

# Reload Hyprland configuration if it's currently running
if hyprctl version >/dev/null 2>&1
    ui-spin --title "Reloading Hyprland configuration..." -- fish -c '
        hyprctl reload >/dev/null 2>&1
    '

    if test $status -eq 0
        ui-success "Hyprland configuration reloaded"
    else
        ui-warning "Failed to reload Hyprland configuration"
    end
else
    ui-info "Start Hyprland with: Hyprland (from TTY)"
end
