#!/usr/bin/env fish
# Setup Hyprland theme system
# Initializes theme directories and sets default theme

echo "→ Setting up themes..."

# Find themes directory - use active profile
if test -L "$HOME/.local/share/fedpunk/.active-config"
    set active_profile (readlink -f "$HOME/.local/share/fedpunk/.active-config")
    set themes_dir "$active_profile/themes"
else
    echo "✗ Error: Active profile not found"
    exit 1
end

# Verify themes directory exists
if not test -d "$themes_dir"
    echo "✗ Error: Themes directory not found at $themes_dir"
    exit 1
end

# Create necessary directories
mkdir -p ~/.config/fedpunk/current
mkdir -p ~/.config/hypr/themes

# Link all themes to ~/.config/hypr/themes/
for theme in $themes_dir/*
    if test -d "$theme"
        set theme_name (basename $theme)
        ln -snf $theme ~/.config/hypr/themes/$theme_name
        echo "  Linked theme: $theme_name"
    end
end

# Set default theme if none is set
set default_theme "ayu-mirage"
if not test -e ~/.config/hypr/active-theme.conf; or not test -L ~/.config/fedpunk/current/theme
    if test -d "$themes_dir/$default_theme"
        set theme_path "$themes_dir/$default_theme"
    else
        # Use first available theme
        set theme_path (find $themes_dir -mindepth 1 -maxdepth 1 -type d 2>/dev/null | head -1)
        set default_theme (basename $theme_path)
    end

    if test -z "$theme_path"
        echo "✗ Error: No themes found"
        exit 1
    end

    echo "  Initializing default theme: $default_theme"

    # Create theme symlink for terminal apps
    ln -snf $theme_path ~/.config/fedpunk/current/theme

    # Setup terminal application themes
    # btop theme
    if test -f "$theme_path/btop.theme"
        mkdir -p ~/.config/btop/themes
        ln -snf "$theme_path/btop.theme" ~/.config/btop/themes/active.theme
    end

    # neovim theme (copy instead of symlink - Lua module loader breaks with symlinks)
    if test -d ~/.config/nvim; and test -f "$theme_path/neovim.lua"
        mkdir -p ~/.config/nvim/lua/plugins
        cp -f "$theme_path/neovim.lua" ~/.config/nvim/lua/plugins/theme.lua
    end

    # Setup desktop application themes
    # kitty theme
    if test -f "$theme_path/kitty.conf"
        mkdir -p ~/.config/kitty
        ln -snf "$theme_path/kitty.conf" ~/.config/kitty/theme.conf
    end

    # waybar theme
    if test -f "$theme_path/waybar.css"
        mkdir -p ~/.config/waybar
        ln -snf "$theme_path/waybar.css" ~/.config/waybar/theme.css
    end

    # mako theme
    if test -f "$theme_path/mako.ini"
        mkdir -p ~/.config/mako
        ln -snf "$theme_path/mako.ini" ~/.config/mako/theme.conf
    end

    # rofi theme
    if test -f "$theme_path/rofi.rasi"
        mkdir -p ~/.config/rofi
        ln -snf "$theme_path/rofi.rasi" ~/.config/rofi/theme.rasi
    end

    # foot theme
    if test -f "$theme_path/.fedpunk-foot.ini"
        mkdir -p ~/.config/foot
        ln -snf "$theme_path/.fedpunk-foot.ini" ~/.config/foot/theme.ini
    else if test -f "$theme_path/foot.ini"
        mkdir -p ~/.config/foot
        ln -snf "$theme_path/foot.ini" ~/.config/foot/theme.ini
    end

    # hyprland active-theme
    if test -f "$theme_path/hyprland.conf"
        mkdir -p ~/.config/hypr
        printf '%s\n' \
            '# Active Hyprland Theme (runtime-generated, gitignored)' \
            '# This file is managed by hyprpunk-theme-set-desktop' \
            '# Do not edit manually - use: fedpunk theme set <theme-name>' \
            '' \
            "source = $theme_path/hyprland.conf" \
            > ~/.config/hypr/active-theme.conf
    end

    echo "  ✓ Default theme set: $default_theme"
else
    echo "  Theme already configured, skipping initialization"
end

# Set wallpaper (always run, even if theme already configured)
if test -L ~/.config/fedpunk/current/theme
    if not test -e ~/.config/hypr/wallpapers/current; or not test -L ~/.config/fedpunk/current/background
        set first_bg (find ~/.config/fedpunk/current/theme/backgrounds -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) 2>/dev/null | sort | head -1)
        if test -n "$first_bg"
            mkdir -p ~/.config/hypr/wallpapers
            ln -snf "$first_bg" ~/.config/fedpunk/current/background
            ln -snf "$first_bg" ~/.config/hypr/wallpapers/current
            echo "  ✓ Wallpaper configured"
        end
    else
        echo "  Wallpaper already configured"
    end
end

echo "✓ Theme setup complete"
