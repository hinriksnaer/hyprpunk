#!/usr/bin/env fish
# Rust/Cargo Setup - Install rustup and configure toolchain

# Source UI functions
source "$FEDPUNK_ROOT/lib/fish/ui.fish"

ui-info "Installing Rust toolchain (required for cargo-based tools)"

# Add cargo to PATH for current session
set -gx PATH $HOME/.cargo/bin $PATH

# Check if rustup is installed
if not command -v rustup >/dev/null 2>&1
    ui-spin --title "Installing Rust toolchain via rustup..." --tail 5 -- fish -c '
        curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --no-modify-path
    '

    ui-success "Rust toolchain installed"
end

# Check if default toolchain is configured (handles partial installs)
if not rustc --version >/dev/null 2>&1
    ui-info "Configuring default Rust toolchain..."

    if not rustup default stable 2>&1
        ui-error "Failed to set default Rust toolchain"
        return 1
    end

    ui-success "Default toolchain configured"
else
    ui-success "Rust already configured: "(rustc --version)
end

# Update Rust to latest stable (only if rustc is working)
if rustc --version >/dev/null 2>&1
    ui-info "Updating Rust to latest stable..."
    if rustup update stable >/dev/null 2>&1
        ui-success "Rust updated to latest stable"
    else
        ui-warning "Failed to update Rust (may already be latest)"
    end
end

ui-info "Rust setup complete"
echo ""
echo "Installed tools:"
echo "  ğŸ¦€ rustc - "(rustc --version)
echo "  ğŸ“¦ cargo - "(cargo --version)
echo "  ğŸ”§ rustup - "(rustup --version)
echo ""
