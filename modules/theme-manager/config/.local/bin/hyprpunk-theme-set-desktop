#!/usr/bin/env fish
# Set desktop theme components (Hyprland, Kitty, Rofi, Mako, wallpapers)
# Also calls terminal theme switcher for consistent theming
# Usage: hyprpunk-theme-set-desktop <theme-name>

# Find script directory for calling other scripts
set script_dir (dirname (status -f))

# Helper functions for output formatting
set C_RESET '\033[0m'
set C_GREEN '\033[0;32m'
set C_BLUE '\033[0;34m'
set C_YELLOW '\033[0;33m'
set C_RED '\033[0;31m'
set GUM_INFO 39
set GUM_SUCCESS 46
set GUM_WARNING 214
set GUM_ERROR 196

function info
    echo -e "$C_BLUE→$C_RESET $argv"
end

function success
    echo -e "$C_GREEN✓$C_RESET $argv"
end

function warning
    echo -e "$C_YELLOW⚠$C_RESET $argv"
end

function error
    echo -e "$C_RED✗$C_RESET $argv"
end

function box
    set message $argv[1]
    echo ""
    echo "╭────────────────────────────────────────╮"
    for line in (echo $message | string split \n)
        echo "│ $line"
    end
    echo "╰────────────────────────────────────────╯"
    echo ""
end

function step
    set description $argv[1]
    set command $argv[2]
    info $description
    eval $command >/dev/null 2>&1
    if test $status -eq 0
        success $description
        return 0
    else
        warning "$description (failed)"
        return 1
    end
end

if test (count $argv) -lt 1
    echo "Usage: hyprpunk-theme-set-desktop <theme-name>"
    echo ""
    echo "Available themes:"
    $script_dir/hyprpunk-theme-list
    exit 1
end

# Find themes directory - use active profile
if test -L "$HOME/.local/share/fedpunk/.active-config"
    set active_profile (readlink -f "$HOME/.local/share/fedpunk/.active-config")
    set themes_dir "$active_profile/themes"
else if test -n "$FEDPUNK_USER"
    set themes_dir "$FEDPUNK_USER/.active-config/themes"
else
    # Try to find relative to script location (for running from repo)
    set script_dir (dirname (status -f))
    set themes_dir (realpath "$script_dir/../../themes")
end

set hyprland_conf "$HOME/.config/hypr/hyprland.conf"

# Normalize theme name (lowercase, convert spaces to dashes)
set theme_name (echo $argv[1] | string lower | string replace -a ' ' '-')

# Check active config themes first, then fall back to built-in themes
if test -L (dirname "$active_config_themes_dir"); and test -d "$active_config_themes_dir/$theme_name"
    set theme_path "$active_config_themes_dir/$theme_name"
else if test -d "$themes_dir/$theme_name"
    set theme_path "$themes_dir/$theme_name"
else
    error "Theme '$theme_name' does not exist"
    echo ""
    echo "Available themes:"
    $script_dir/hyprpunk-theme-list
    exit 1
end

set pretty_name (echo $theme_name | sed 's/-/ /g; s/\b\(.\)/\u\1/g')

echo ""
box "Switching to theme: $pretty_name" $GUM_INFO
echo ""

set applied_count 0
set skipped_count 0

# Update Hyprland active theme file to source the theme's hyprland.conf
if test -f "$theme_path/hyprland.conf"
    set active_theme_conf "$HOME/.config/hypr/active-theme.conf"
    printf '%s\n' \
        '# Active Hyprland Theme (runtime-generated, gitignored)' \
        '# This file is managed by hyprpunk-theme-set-desktop' \
        '# Do not edit manually - use: fedpunk theme set <theme-name>' \
        '' \
        "source = $theme_path/hyprland.conf" \
        > $active_theme_conf
    if test $status -eq 0
        success "Applying Hyprland theme"
        set applied_count (math $applied_count + 1)
    else
        warning "Applying Hyprland theme (failed)"
    end
else
    warning "Skipped hyprland.conf (not found in theme)"
    set skipped_count (math $skipped_count + 1)
end

# Desktop theme file mappings: source -> destination (symlinks)
# Note: Neovim theme is handled separately by terminal switcher (copied, not symlinked)
set -l desktop_theme_mappings \
    "kitty.conf:$HOME/.config/kitty/theme.conf" \
    ".fedpunk-foot.ini|foot.ini:$HOME/.config/foot/theme.ini" \
    "rofi.rasi:$HOME/.config/rofi/theme.rasi" \
    "mako.ini:$HOME/.config/mako/theme.conf" \
    "waybar.css:$HOME/.config/waybar/theme.css" \
    "hyprlock.conf:$HOME/.config/hypr/hyprlock-theme.conf"

# Apply desktop theme files (symlinks)
info "Linking desktop application themes"
for mapping in $desktop_theme_mappings
    set parts (string split ":" $mapping)
    set source_files $parts[1]
    set dest_path $parts[2]

    # Check for primary file first, then fallback(s)
    set source_path ""
    set used_file ""
    for candidate in (string split "|" $source_files)
        if test -f "$theme_path/$candidate"
            set source_path "$theme_path/$candidate"
            set used_file $candidate
            break
        end
    end

    if test -n "$source_path"
        # Create destination directory if needed
        set dest_dir (dirname $dest_path)
        mkdir -p $dest_dir 2>/dev/null

        # Create symlink
        ln -sf $source_path $dest_path
        set applied_count (math $applied_count + 1)
        success "Applied $used_file"
    else
        set skipped_count (math $skipped_count + 1)
        set first_candidate (string split "|" $source_files)[1]
        warning "Skipped $first_candidate (not found in theme)"
    end
end

# Apply terminal themes
echo ""
info "Applying terminal themes"
set terminal_result ($script_dir/hyprpunk-theme-set-terminal $theme_name)
set terminal_counts (string split ":" $terminal_result)
set terminal_applied $terminal_counts[1]
set terminal_skipped $terminal_counts[2]
set applied_count (math $applied_count + $terminal_applied)
set skipped_count (math $skipped_count + $terminal_skipped)
success "Terminal themes applied"

# Set wallpaper from theme
echo ""
if step "Setting wallpaper" "$script_dir/hyprpunk-wallpaper-set $theme_name"
    # Success handled by step function
end

# Reload applications
echo ""
info "Reloading applications"

# Reload Hyprland
if step "Reloading Hyprland" "hyprctl reload"
    # Success handled by step function
end

# Reload btop if running
if pgrep -x btop >/dev/null 2>&1
    if step "Refreshing btop" "pkill -SIGUSR2 btop"
        # Success handled by step function
    end
end

# Reload kitty config if running
if pgrep -x kitty >/dev/null 2>&1
    if step "Reloading kitty config" "killall -SIGUSR1 kitty"
        # Success handled by step function
    end
end

# Reload mako notification daemon if running
if pgrep -x mako >/dev/null 2>&1
    if step "Reloading mako" "killall -SIGUSR2 mako"
        # Success handled by step function
    end
end

# Reload waybar if running (restart for reliable theme update)
if pgrep -x waybar >/dev/null 2>&1
    if step "Reloading waybar" "pkill waybar && sleep 0.1 && waybar &"
        # Success handled by step function
    end
end

# Update theme in running podman containers (devcontainers)
if command -v podman >/dev/null 2>&1
    # Get list of running containers
    set containers (podman ps --format "{{.Names}}" 2>/dev/null)

    for container in $containers
        # Check if fedpunk is installed in the container
        if podman exec $container test -f /root/.local/bin/fedpunk 2>/dev/null
            echo ""
            info "Updating theme in container: $container"
            if podman exec $container /root/.local/bin/fedpunk theme set $theme_name >/dev/null 2>&1
                success "Updated $container"
            else
                warning "Failed to update $container"
            end
        end
    end
end

# Send notification
if step "Sending notification" "notify-send 'Theme Changed' 'Switched to: $pretty_name\n$applied_count files applied, $skipped_count skipped' -t 3000"
    # Success handled by step function
end

# Final summary
echo ""
box "Theme switched to: $pretty_name

Applied: $applied_count  •  Skipped: $skipped_count" $GUM_SUCCESS
echo ""
