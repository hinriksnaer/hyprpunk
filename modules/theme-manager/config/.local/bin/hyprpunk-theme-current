#!/usr/bin/env fish
# Get the currently active theme
# Usage: hyprpunk-theme-current

# Find themes directory - use active profile
if test -L "$HOME/.local/share/fedpunk/.active-config"
    set active_profile (readlink -f "$HOME/.local/share/fedpunk/.active-config")
    set themes_dir "$active_profile/themes"
else if test -n "$FEDPUNK_USER"
    set themes_dir "$FEDPUNK_USER/.active-config/themes"
else
    # Try to find relative to script location (for running from repo)
    set script_dir (dirname (status -f))
    set themes_dir (realpath "$script_dir/../../themes")
end

# First try active-theme.conf (most accurate for desktop)
set active_theme_conf "$HOME/.config/hypr/active-theme.conf"
if test -f "$active_theme_conf"
    set current_line (grep "source.*themes.*hyprland.conf" $active_theme_conf 2>/dev/null)

    if test -n "$current_line"
        # Extract theme name from path
        set theme_name (echo $current_line | sed 's|.*themes/\([^/]*\)/.*|\1|')

        # Verify the theme directory actually exists
        if test -d "$themes_dir/$theme_name"
            # Format nicely: convert dashes to spaces and capitalize
            echo $theme_name | sed 's/-/ /g; s/\b\(.\)/\u\1/g'
            exit 0
        end
    end
end

# Fallback: try the common theme symlink (works for terminal-only)
if test -L "$HOME/.config/fedpunk/current/theme"
    set theme_name (basename (readlink "$HOME/.config/fedpunk/current/theme"))

    # Verify the theme directory actually exists
    if test -d "$themes_dir/$theme_name"
        # Format nicely: convert dashes to spaces and capitalize
        echo $theme_name | sed 's/-/ /g; s/\b\(.\)/\u\1/g'
        exit 0
    end
end

# No valid theme found
echo ""
exit 1
