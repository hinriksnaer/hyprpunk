#!/usr/bin/env fish
# Setup tmux plugin manager (TPM) and install plugins

source "$FEDPUNK_ROOT/lib/fish/ui.fish"

ui-info "Setting up tmux plugin manager"

# Use XDG-compliant location
set -l tpm_path "$HOME/.config/tmux/plugins/tpm"

# Clone TPM if not already installed
if not test -d "$tpm_path"
    ui-spin --title "Cloning tmux plugin manager..." -- fish -c '
        mkdir -p '$HOME'/.config/tmux/plugins
        git clone https://github.com/tmux-plugins/tpm '$HOME'/.config/tmux/plugins/tpm >/dev/null 2>&1
    '

    if test $status -eq 0
        ui-success "Tmux plugin manager cloned"
    else
        ui-error "Failed to clone tmux plugin manager"
        return 1
    end
else
    ui-success "Tmux plugin manager already installed"
end

# Create legacy symlink for compatibility
if not test -e "$HOME/.tmux/plugins/tpm"
    mkdir -p "$HOME/.tmux/plugins"
    ln -sf "$tpm_path" "$HOME/.tmux/plugins/tpm"
    ui-info "Created compatibility symlink at ~/.tmux/plugins/tpm"
end

# Install plugins if tmux config exists
if test -f "$HOME/.config/tmux/tmux.conf"
    ui-spin --title "Installing tmux plugins..." -- fish -c '
        # Run the TPM install script directly - simpler and more reliable
        bash '$HOME'/.config/tmux/plugins/tpm/scripts/install_plugins.sh >/dev/null 2>&1
    '

    if test $status -eq 0
        ui-success "Tmux plugins installed"
    else
        ui-warning "Tmux plugin installation may have issues"
        ui-info "You can install manually with: bash ~/.config/tmux/plugins/tpm/scripts/install_plugins.sh"
    end
else
    ui-warning "Tmux config not found, skipping plugin installation"
    ui-info "Plugins will be installed on first tmux launch"
end

ui-success "Tmux setup complete"
