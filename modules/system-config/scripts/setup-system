#!/usr/bin/env fish
# Shared system setup: git submodules, system upgrade, core utilities, SELinux

# Source UI functions
source "$FEDPUNK_ROOT/lib/fish/ui.fish"

ui-section "System Setup"

# Verify FEDPUNK_ROOT exists before changing to it
if not test -d "$FEDPUNK_ROOT"
    ui-error "FEDPUNK_ROOT not set or directory doesn't exist: $FEDPUNK_ROOT"
    return 1
end

cd "$FEDPUNK_ROOT"

# Git submodules
ui-info "Initializing git submodules"

# Check if any submodules use git-lfs
if git submodule foreach --quiet 'git lfs ls-files -s' 2>/dev/null | grep -q .
    ui-spin --title "Installing git-lfs..." -- fish -c '
        sudo dnf install -qy git-lfs >/dev/null 2>&1
    '

    if test $status -eq 0
        ui-success "git-lfs installed"
        if not git lfs install >/dev/null 2>&1
            ui-warning "git-lfs installation failed, continuing anyway"
        end
    else
        ui-warning "Failed to install git-lfs, continuing anyway"
    end
end

# Sync git submodules
ui-spin --title "Syncing git submodules..." -- fish -c '
    git submodule sync --recursive >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "Syncing git submodules"
else
    ui-error "Syncing git submodules failed"
end

# Update git submodules
ui-spin --title "Updating git submodules..." -- fish -c '
    git submodule update --init --recursive >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "Updating git submodules"
else
    ui-error "Updating git submodules failed"
end

# SELinux configuration
echo ""
ui-info "Checking SELinux configuration"

# Check if getenforce command exists
if command -v getenforce >/dev/null 2>&1
    set selinux_status (getenforce 2>/dev/null || echo "Disabled")
else
    set selinux_status "Not Available"
end

ui-info "SELinux status: $selinux_status"

if test "$selinux_status" = "Enforcing"
    # Enable user executable content in home directory
    ui-spin --title "Enabling user_exec_content..." -- fish -c '
        sudo setsebool -P user_exec_content on >/dev/null 2>&1
    '

    if test $status -eq 0
        ui-success "user_exec_content enabled"
    else
        ui-warning "Failed to enable user_exec_content"
    end

    # Fix SELinux contexts for Fedpunk-managed directories only
    # NOTE: We only restore contexts for directories Fedpunk creates/modifies
    # to avoid scanning millions of files (e.g., container storage)
    set home_dir (eval echo ~)
    set fedpunk_dirs "$home_dir/.config/hypr" "$home_dir/.config/kitty" "$home_dir/.config/fish" "$home_dir/.config/nvim" "$home_dir/.local/bin" "$home_dir/.local/share/fedpunk"

    ui-spin --title "Restoring SELinux contexts for Fedpunk directories..." -- fish -c '
        for dir in '$fedpunk_dirs'
            if test -d "$dir"
                sudo restorecon -R "$dir" >/dev/null 2>&1
            end
        end
    '

    if test $status -eq 0
        ui-success "SELinux contexts restored for Fedpunk directories"
    else
        ui-warning "Some SELinux context restorations may have failed"
    end

    ui-success "SELinux configuration complete"
else
    ui-info "SELinux not enforcing, skipping SELinux setup"
end

echo ""
ui-box "Shared System Setup Complete!"
